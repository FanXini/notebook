---
typora-copy-images-to: ..\..\img
---

# 网络层详解

运输层提供进程到进程间的逻辑通信

网络层提供主机到主机间的逻辑通信

ip地址与接口关联而不是与接口的主机或路由器相连

网络层的两个主要功能是转发和路由选择。

- 转发：当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路
- 路由选择。当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法称为路由选择算法。

&emsp;&emsp;再讨论网络层时，许多人都会将转发和路由混为一谈。但是初学者还是要明确的知道这两个术语的精确含义和区别。转发是值将分组从一个输入链路转移到适当的输出链路接口的路由器的本地动作，它只运行在路由器里面，是一个局部的动作。而路由选择是一个宏观的概念，决定了数据从发送方到接收方的整个路径。用驾驶的例子进行类比，考虑在你是一个旅游者，需要从你的城市自驾游到西藏，路途中经历了很多立交桥。我们能够认为转发就像通过单个立交桥的过程，你沿道路上进入立交桥的一个入口，并且决定应当走哪条路来离开立交桥。而路由选择是规划从你的城市到西藏的路径，可能会有很多条行得通的路径，而你根据你的需要选择最适合的你的一条。所以这两个动作一个局部，一个全局。 

在学习IP前，介绍因特网网络层中的3个主要组件：如图4.12

1. IP协议：
   - 编址规则
   - 数据报的格式
   - 分组处理规则
2. 路由选择协议，决定了数据报从源到目的地的路径
3. ICMP(intenet control management protocol),用来报告数据报的错误和对某些网络层信息请求进行响应的设施。比如ping返回的信息就是ICMP信息。

![1564307173673](..\..\img\1564307173673.png)

## 1. 虚拟网络和数据报网络

&emsp;&emsp;运输层提供了无连接的服务UDP和面向连接的服务TCP,网络层也能够在两台主机无连接或者连接服务。网络层的连接和无连接的服务与运输层类似。例如，网络层连接服务以源和目的主机间的握手开始；网络层无连接服务则没有任何握手预备步骤。但同时也会存在一些重要的差异：

- 网络层中，这些服务是由网络层向运输层提供的主机到主机的服务。在运输层中，是运输层向应用层提供的进程到进程的服务。
- 在网络层中提供面向连接的服务叫做虚电路。在网络层中提供无连接服务的计算机网络称为数据报服务。
- 在网络层和运输层面向连接服务与在网络层实现连接的服务是完全不同的。运输层的连接服务实际上是虚连接，仅在网络边缘的端系统中实现(发送和接收缓存，接收窗口等变量)。而网络层的连接除了在端系统中实现，还在网络核心中的路由器实现，每个路由器都维持连接的状态，如图4.4。因此，网络层的连接服务是个实连接。

![1564302849222](..\..\img\1564302849222.png)

这里，我们只讨论离我们最近的因特网中的数据报网络。

## 2. 数据报网络

&emsp;&emsp;在数据报网络中，每当一个端系统发送一个分组时，它就为该分组加上目的地系统的地址，然后将分组推进网络中，如图4.5。无需建立任何虚电路，路由器不维护任何的状态信息。当分组到达路由器是，根据分组的目的地址的前缀信息去匹配路由器维护的转发表，找到对应输出链路。

![1564302899839](..\..\img\1564302899839.png)



## 3. 路由器的工作原理

图4.6显示了一个通用路由器结构的总体视图。其中标识了一台路由器的4个组件。

![1564303777776](..\..\img\1564303777776.png)

- 输入端口(input port)。输入端口执行几项关键功能。
  1. 执行将一条输入的物理链路与路由器相连接的物理层功能。对应最左边的方框
  2. 执行数据链路层功能，对应中间方框
  3. 执行查找转发表功能，对应最右边方框。
- 交换结构(switch fabric)，将分组从输入链路发送到输出链路。
- 输出端口
  1. 输出端口接收交换结构接收的分组，并执行链路层和物理层功能在输出链路上传输这些分组。当一条链路是双向链路时，输出端口通常是与该链路的输入端口在同一线路卡(一个包含一个或多个输入端口的印刷电路，它与交换结构相连)上成对出现。
- 路由选择处理器(Routing Process)。路由选择处理器执行路由选择协议，维护路由选择表以及连接的链路状态信息，并为路由器计算转发吧。

因此，路由器的输入端口，输出端口和交换结构共同实现了这种转发功能，且总是使用硬件实现。

### 3.1 输入端口

![1564305568991](..\..\img\1564305568991.png)

line terminal:线路终端

Data link processing（protocol decapsulation）：数据链路处理(协议、拆封)

- 检查分组的版本号、检验和’、寿命字段，请重写后面两个字段

Lookup,fowarding,queuing:查找，转发，排队

Switch fabric：交换结构

### 3.2 输出端口

![1564305959336](..\..\img\1564305959336.png)

Queuing（buffer management）:排队(缓存管理)

Data ling processing(protocol encapsulation)数据链路处理(协议，封装)

Line termination:线路端接

## 4 网际协议：因特网中的转发和编址

目前存在两个版本

1. IPV4
2. IPV6

### 4.1 数据报格式

![1564307562425](..\..\img\1564307562425.png)

- **version**:4比特，版本号。通过查看版本号，可以确定如何解释IP数据报的剩余部分。不同的IP版本使用不同的数据报格式。目前的两个版本：IPV4和IPV6。

- **Header length**:4比特，首部长度。因为一个IPV4数据报可以包含一些可变数量的选项，故需要用这4比特确定IP数据报中数据部分实际上是从哪开始，一般数据报都不包含选项，因此，首部一般是20个字节。

- **Type of service**：用来区分不同 的IP数据类型，将低时延、高吞吐量和高可靠性的数据报分隔开。

- **Datagram length**:数据报长度(首部+数据)

- identifier:标识 Flag：标志  Fragmentation offset:片移位 这三个与数据报分片有关。

- **Time to live**:TTL 寿命，数据报每经过一个路由器，寿命-1，当寿命为0 时，数据报被丢弃，保证数据不会在网络中循环。

- **Upper-layyer** protocol:上层协议，指示了该数据报应该上交给哪个运输层协议。值为6表示数据部分交给TCP，值为17表示要交给UDP。协议号是将运输层和网络层连接在一起的粘合剂，端口号是应用层和运输层连接在一起的粘合剂，同理，链接层也有和网络层连接在一起的粘合剂。后面会介绍到

- **Header checksum**:首部检验和，首部字段检验和，如果数据报携带的检验和与计算首部检验和不一致，则路由器会丢弃该数据报。因为TTL每经过一个路由器就会改变，所以检验和在每个路由器都要进行重新计算并再次放回原处。

  一个问题？为什么TCP/IP在运输层和网络层都需要进行检验和验证？这种重复检验有以下几个原因：

  - 注意到IP层只对IP首部计算了检验和，而TCP/UDP检验和是对这个TCP/UDP整个报文段进行的
  - TCP/UDP不一定与IP必须是一个协议栈，原则上TCP能运行在一个不同的协议(如ATM)上，而IP能够携带不一定要传递给TCP/UDP的数据。

- **source ip address | destination ip address**:源和目的地址

- option:选项，选项字段允许ip首部被扩展。但很少被使用

- Data:数据，有效载荷，大多数情况承载的是TCP或UDP的运输层报文段。但也可以承载其他类型的报文段，比如协议报文，ICMP等

### 4.2 IP数据报分片

&emsp;&emsp;数据报的大小需要小于最大链路层帧长度MTU(Maximum Transmission Unit)，因为不同的链路层协议会有不同的MTU。比如以太网帧可以承载1500字节的数据，而某些广域网可以承载不超过576字节的数据。因为数据从源传输到目的地的路径上可能会存在不同的链路层协议，每个协议又会有不同的MTU，那可能会存在运输过程中数据转发到输出端口时发现IP数据报比MTU大，那怎么把这个过大的IP分组压缩进链路层帧的有效载荷字段呢?&

&emsp;&emsp;解决这个问题的办法是分片，将原IP数据报切割成多个数据报，再封装到链路层帧中。这个时候要解决的问题就是如何判断哪些数据是经过切割的，哪些片是同属于一个原数据的，怎么组合这些片还原回原数据。IPv4的设计者将标识，标志和片偏移字段放到数据报的首部。当生成一个数据报时，发送主机在为该数据设置源和目的地址的同时再贴上标识，发送主机通常将为它发送的每个数据包的标识号+1。当路由器需要对一个数据报分片时，形成的每个数据片都有原始的源和目的地址与标识号。因此，当目的主机接收到一系列数据时，可以通过标识号知道哪些数据实际上是同一个较大数据报的片。由于IP是一种不可靠的服务，一个或多个片可能永远到达不了目的地。因此，为了让目的主机决定的相信它已经收到了初始数据报的最后一个片，它将最后一个片的标志比特设为0，而其他片的比特都设为1.另外，为了让目的主机确认是否丢失了一个片且能按照顺序组装，使用偏移字段指定该片应放在初始IP数据报的哪个位置。

**为了保证性能，片的重新组装在端系统完成而不在网络路由器完成。**在目的地，只有被组装完好的的数据才会被上传给运输层，否则会被丢弃

**分割原则**：除了最后一个片外，其他的片的有效载荷数据的数量是8字节的倍数，并且偏移值应当被规定为以8字节块为单位

&emsp;&emsp;例如发送一个4000字节的数据报(20字节的IP首部+3980有效载荷)到达一台路由器，且要被转发到一条MTU为1500字节的链路上。这就意味着数据报中的3980字节数据必须分配为3个独立的片(其中每个片也是一个IP数据报)，如图4-14，假定初始数据报的标识号为777，那么分配的结果如表4-2

![1564370270663](..\..\img\1564370270663.png)

![1564370289199](..\..\img\1564370289199.png)

#### 缺陷

&emsp;&emsp;如果攻击者发送很多没有标志位为0的数据片，或者发送一些无法正确组合的数据片，系统会无法应对，直到资源被耗尽导致系统崩溃。因此在IPV6中取消了分片机制。在IPv6中，如果数据分组>MTU，则直接丢去，并向发送发发回一个"分组太大"的ICMP差错报文，使得发送发能重发该报文。

### 4.3 IPv4 编址

&emsp;&emsp;ip地址与接口关联而不是与接口的主机或路由器相连.v4IP地址占用4个字节，使用点分十进制发，如：255.255.255.255标识11111111 11111111 11111111 11111111。

&emsp;&emsp;因特网的地址分配策略被称为无类别域间路由选择(Classless Interdomain Routing CIDR)

&emsp;&emsp;ip分为两个部分，前缀用于路由寻址，叫做子网，后缀用于组织内部中的主机寻址。比如 224.1.1.0/24 表情该IP地址的前24字节是子网地址。一个组织通常被分配一块连续的地址，即具有相同的前缀

&emsp;&emsp;一个具有多个以太网段和点对点链路的组织将具有多个子网，在给定子网上的所有设备都具有相同的子网地址。原则上，不同的子网能够具有不同的子网地址。然而，在实践中，它们的子网地址往往会在许多共同之处。

#### 4.3.1 地址聚合

使用单个网络前缀通告多个网络的能力叫做地址聚合，也称为路由聚合或路由摘要。

![1564372401966](..\..\img\1564372401966.png)

如上图，Fly-By-Night-ISP向外面通过200.23.16.0/20。外界的其他部分不知道在地址块内实际上还存在8个其他的组织，每个组织都有自己的组网。使用这种机制，大大增加的前缀的作用范围。

&emsp;&emsp;但是，如果存在下图这种情况，IP地址分配不是完全按照层次结构划分，比如想将组织200.23.18.0/23不与新申请到的ISPs-R-Us相连。但是组织1的地址在该地址快之外，一种办法是重新编号组织1路由器和主机，使得地址在ISPs-R-Us。但是这样代价太大，还有一种办法是，组织1保持其ip地址在200.23.18.0/23内。在这种情况下，如图4.19所示，Fly-By-Night-ISP继续通告200.23.16.0/20，并且ISPs-R-Us继续通告199.31.0.0/16，但同时还通告200.23.18.0/23。当在更大的因特网中看到地址块200.23.16.0/20和200.23.16.0/23并想路由选择到后者，它们会根据最**长前缀匹配**，朝着ISPs-R-Us路由。

![1564376855178](..\..\img\1564376855178.png)

### 4.4 DHCP 

Dynamic Host Configuration Protocol动态主机配置协议

&emsp;&emsp;一旦一个组织申请到了一块地址，它就可以为组织能得主机或者路由器分配IP地址。一种方法是网络管理员手动分配，另一种方法则是使用DHCP自动分配IP地址。管理员可以配置DHCP服务器使得每个主机在获取IP地址时都得到相同得IP地址，或者只是一个临时IP地址，同时DHCP还会让主机获取到额外的信息，比如子网掩码，默认网关路由器和本地DNS服务器。

&emsp;&emsp;DHCP是一个即插即用的协议，同时也是一个客户端-服务端协议。

主机通过DHCP获取IP地址的流程如下：

![1564385931691](..\..\img\1564385931691.png)

1. 主机发送一个源IP地址0.0.0.0,端口号为68，目的IP地址为广播地址255.255.255.255，端口号为67的DHCP发送报文。
2. DHCP服务器收到请求报文后响应，回馈DHCP提供报文
3. 主机可能同时收到多个DHCP提供报文，因此有必要对自己意向的IP提供者发送DHCP请求
4. 被选择的DHCP服务器发送DHCP ACK报文。

在实践中一般使用后两个步骤就行。

### 4.5 NAT

netword address translation :网络地址转换

现在IP的发明者担忧4字节的IP地址被耗尽。或者当一个用户申请了一个地址空间，可以分配地址空间了，当用户的主机数量扩展到第五个之后，将没有更多的IP地址空间分配了。

为了解决这两个问题，提供了NAT机制，极大的扩大了IP地址的利用率。

网络开发者保留了3部分IP地址，这些地址用于向上面说的家庭网络等专用网络或具有专用地址的地域，这三部分地址分别是：

1. 10.0.0.0—10.255.255.255(10.0.0.0/8)
2. 172.16.0.0-172.31.255.255(172.16.0.0/12)
3. 192.168.0.0-192.168.255.255(192.168.0.0/16)

![1564388370765](..\..\img\1564388370765.png)

如上图，ip地址为10.0.0.1想与ip地址为128.119.40.186的Web服务器请求一个web页面，当请求报文到达NAT路由器时，路由器会为该数据生成一个新的源端口5001(当前时刻NAT转换表中没有重复)，并将源IP地址代替为广域网一侧的ip地址138.76.29.7，同时在NAT转换表中增加一个映射记录。当web服务器返回了报文时，数据分组到了NAT路由器中，则根据转换表中的映射记录重新设置报文的目的地址和目的端口。这样，多个主机可以公用一个WAN IP地址。

## 5 ICMP 

**Intenet Control Management Protocl** 因特网控制管理协议

&emsp;&emsp;ICMP被主机和路由器用来彼此沟通网络层的信息。ICMP最典型的用途是差错报告。例如当运行一个Telnet,FTP或HTTP应用所指定的主机，你可能会遇到"目的地不可达"之类的错误报文，这种报文就是在ICMP中产生的，比如找不到通往目的地的路径，该路由器就会向你的主机创建和发出一个类型3的报文。

&emsp;&emsp;ICMP通常被认为是IP的一部分，但是严格从体系结构上来看，它是在IP协议之上的，因为ICMP报文是作为IP数据报的有效载荷。就像TCP/UDP报文是IP的有效载荷一样。类型，当一台主机收到一个指明上层协议为ICMP的IP数据报时，它分解出有效ICMP报文段给ICMP.

&emsp;&emsp;ICMP报文有一个类型字段和一个编码字段

![1564391550348](..\..\img\1564391550348.png)

众所周知的ping程序发送一个ICMP类型8编码为0的报文到指定主机。看到该回显请求，目的返回一个类型0编码0的ICMP回显回答。

## 6 路由选择协议

总体来说，路由选择算法分为两种

- 全局路由选择算法：用完整的，全局性的网络知识计算出从源到目的地之间的最低费用路径。实践中，这种算法称为链路状态(Link Status)算法。
- 分散式路由选择算法：以迭代、分布式的方式计算最低费用路径。没有节点拥有关于网络完整信息，而每个节点仅有与其直接相连链路的费用知识就可以开始工作。实践中有一个称为距离向量(Distance-Vector,DV)的算法。

### 6.1 链路状态路由选择算法

&emsp;&emsp;每个节点的路由信息修改之后都会在广播域里面进行广播，结果是所有的结点具有该网络等同、完整的视图。于是每一个结点都可以运行相同的LS算法进行路由选择。

&emsp;&emsp;下面介绍一个称为Dijkstra算法的LS算法，它可以计算从节点到其他节点的最短路由路径。

伪代码算法：

D(v):到算法的本次迭代，从源结点到目的结点v的最低费用路径的费用。

p(v):从源到v沿着当前最低路径的前一结点(v的邻居)

c(u,v) 相邻结点u,v的路径开支

N’:结点子集；如果从源到v的最低费用路径已确知，v在N‘

该算法由一个初始化步骤和其后的循环组成。循环的次数和网络中的结点相同。

![1564395242217](..\..\img\1564395242217.png)

考虑图4-27中的网络,计算从u到所有可能目的地的最低费用路径

![1564447314435](..\..\img\1564447314435.png)

![1564447844582](..\..\img\1564447844582.png)

- 在初始步骤，根据u相邻节点费用进行初始化，因为y、z不是其相邻结点，所以费用设为无穷大。

- 选择不在N’中但D(node)最小的结点，从初始化后的结果来看，D(x)=1 是最小的，所以将x加入到N'中。于是开始执行第11，12行代码，重新计算D(v)，计算公式为

  $$D(v)=min(D(v),D(v)+c(w,v))$$

- 如此循环下去，直到N‘=N

&emsp;&emsp;当LS算法终止时，对于每个结点，我们都得到从源节点沿着它的最低路径的前一节点，对于每一个前一节点，我们又有它的前一节点，以此方式我们可以构建出从源节点到所有目的结点的完整路径。图4-28显示了对于图4-27中的网络产生的最低费用路径和u中的转发表。

![1564448708743](..\..\img\1564448708743.png)

### 6.2 距离向量路由选择算法

&emsp;&emsp;距离向量(Distance-Vector,DV)算法是一种迭代的、异步的和分布式的算法，而LS是一种使用全局信息的算法。许多类型DV算法在实践中被用于多种路由选择协议中，比如RIP和BGP。DV算法只需要路由器获取相邻结点的路由信息就可以开始工作。它利用了著名的Bellman-Ford方程相关：
$$
D_{x}(y)=\min _{v}\left\{c(x, v)+D_{v}(y)\right\} \quad \text { for each node } y \text { in } N
$$
d~x~(y)是从结点x到结点y的最低费用路径，v是x的邻近结点

伪代码如下：

![1564450387599](..\..\img\1564450387599.png)

- 首先初始化本地路由信息，相邻结点的费用。
- 接收到相邻结点的路由变化信息，则使用公式进行计算，修改路由信息。如果结点到其他结点的路由信息改变了，则向相邻结点发送改变后的路由信息

图4-30演示了DV算法的运行机制：

![1564450866392](..\..\img\1564450866392.png)

图中由3个结点x、y、z，路径上的数字是通信费用。

- 首先，图的最左边一列显示了这3个结点各自的初始路由选择表。每一行都是距离向量。

- 初始化后，每个结点向它的两个邻居发送其距离向量，图中从表的第一列到表的第二列的箭头显示了这个情况。再接收到相邻结点的信息后，根据公式重新计算自己的距离向量，例如，结点x计算：

  ![1564451510686](..\..\img\1564451510686.png)

- 计算之后，自己距离向量由变化的结点向邻居结点发送它们的更新距离向量，直到距离向量不变为止。

因此，可以看出，每个结点x维护以下路由选择信息：

1. 对于每个邻近v,从x到直接相连邻居v的费用为c(x,v)
2. 结点x的的距离向量：包含了x到N中的所有目的地y的费用的估计值
3. 它的每个邻居的距离向量，即对x的每个邻居v,由D~V~=[D~V~(y)]

每当接收到邻居的路由选择更新信息，则使用公式进行更新
$$
D_{x}(y)=\min _{v}\left\{c(x, v)+D_{v}(y)\right\} \quad \text { for each node } y \text { in } N
$$

### 6.3 层次路由选择

&emsp;&emsp;针对规模问题和组织对网络的管理自治问题，提出使用自治系统**autonomous systems**
**(ASs),**来解决，每个AS由一组通常处在相同管理控制器下的路由器组成，在相同的AS中使用相同的路由选择算法，且拥有彼此的信息，这种算法称为自治系统内部路由选择协议。同时，为了和外部通信，因此需要将分组转发到其他AS的路由器，叫做网关路由器。

&emsp;&emsp;因此根据层次来划分，可以分为:

- 自治系统内部路由选择协议（ intra autonomous system routing protocol.）
- 自治系统间路由选择协议 （ inter-autonomous system routing protocol.）

![1564453755945](..\..\img\1564453755945.png)

在AS2和AS3中，只有一条通往外外部的路径，即通过2a/3a。当向AS1中存在多条通往外部的路径，那路由器应该向1c发送分组还是1b分组呢？为了解决这个问题，AS1需要知道

1. 经过AS2可达哪些地方，经过AS3可达哪些地方
2. 向AS1中的所有路由器转发这些信息，因此每台路由器能够配置它的转发表以及处理外部AS目的地。

这种从相邻AS获取可达性信息和向该AS中的所有路由器传播可达性信息是两项由自治系统间路由选择协议处理的任务。

## 7 因特网中的路由选择

### 7.1 因特网中自治系统内部的路由选择

#### 7.1.1 RIP 路由选择信息协议

Routing Information Protocol

&emsp;&emsp;RIP是一种DV算法，与第6节介绍的理想化DV算法相似，它使用从源到目的地的子网数量作为其费用路径，一条路径的最大长度为15,所以RIP只能用在网络直径不超过15跳的自治系统。下图表明了从A到每个叶子子网的跳数：

![1564454997552](..\..\img\1564454997552.png)

&emsp;&emsp;路由器之间使用RIP响应(通告)报文进行路由选择信息转发。每张路由器维护一张称为路由选择表的RIP表。RIP表包括路由器的距离向量和该路由器的转发表。

![1564455435963](..\..\img\1564455435963.png)

以4.35 为例的AS系统，最开始其转发表如下所示：

![1564455500944](..\..\img\1564455500944.png)

三列分别表示:目的子网，下一台路由器，到目的地的跳数。从上表看出，D到w的子网的下一路由器A，且要经过2跳。到z的子网下一跳路由器是B，要经过7跳。

30s之后路由器收到来自路由器A的RIP通告，如4-37

![1564455730863](..\..\img\1564455730863.png)

D路由器根据DV算法，发现从路由器A到子网只有4跳，修改转发表，得到4.38

![1564456101518](..\..\img\1564456101518.png)

路由器也可使用RIP请求报文主动请求邻居到指定目的地的费用。

路由器在UDP上使用端口520相互发送RIP请求和响应报文。封装在IP数据报中的UDP报文段在路由器之间传输。看出，RIP使用一个位于网络层之上的UDP运输层协议实现网络层的功能，有点费劲，和ICMP有点相似，所以看出，实际上的网络路由协议很难按照OSI划分的层次完全分离。

#### 7.1.2 OSPF 开发最短路优先

Open Shortest Path First ，开发最短路优先

使用OSPF,路由器向AS内的所有路由器广播路由选择信息，而不仅仅是向其相邻路由器广播。每当一条链路的状态发生变化时，路由器就会广播链路状态。

因此，其核心就是一个使用洪泛链路状态信息的链路状态协议和一个前面介绍的Dijkstrea最低费用路径算法。

### 7.2 因特网中自治系统间的路由选择 BGP

BGP :Border Gateway Protocol 边界网关协议

7.1学习的RIP和OSPF决定AS内部的源和目的对之间的优化路径，而BGP为每个AS提供了进行一下工作的手段：

1. 从相邻AS获得子网可达性信息
2. 向本AS内部的所有路由器传播可达性信息
3. 基于可达性信息和AS策略，决定到达子网的“好”路由

BGP使得每个子网向因特网的其余部分通告它的存在。在BGP中，路由器对通过使用179端口的半永久连接交换路由选择信息，沿着连接发送BGP报文的TCP连接称为BGP会话，根据对等方是否在同一个AS将会话分为

- 外部BGP会话 eBGP
- 内部BGP会话 iBGP

![1564457389825](..\..\img\1564457389825.png)

BGP使得每个AS知道经过其相邻的AS可达哪些地方。在BGP中，目的地是前缀，每个前缀表示一个子网或者是子网的集合.比如由四个子网与AS2相连: 138.16.64/24, 138.16.65/24, 138.16.66/24, and 138.16.67/24. 则AS2能聚合这四个子网，并使用BGP向AS1通告诉单一前缀：138.16.64/22.

#### 路径数据和BGP路由

&emsp;&emsp;在BGP中，每个自治系统都有一个全局唯一的自治系统号ASN,就像IP地址一样，AS号由ICANN分配。

&emsp;&emsp;当一台路由器通过BGP会话通告一个前缀时，它在前缀包括一些BGP属性。用BGP术语来讲，带有属性的前缀称为一条路由。两个重要的属性时AS-PATH和next-hop

- AS-PATH：包含了前缀的通告已经通过的那些AS。每当路由到达一个AS时，添加其ASN。发现自己的ASN在AS-PATH中，则拒绝通告，防止循环通告。
- NEXT-HOP:NEXT-HOP是一个开始某AS-PATH的路由器接口。为了深入理解该属性，我们再次看图4-40。当3a向1c通告路由，该路由包括前缀，AS-PATH和NEXT-HOP，这是路由器3a通向1c的接口的IP地址，1c在AS1广播。当1d得知x这条路由后，路由器1d想要沿着这条路由向x转发分组，即路由器1d可能要在其转发表中包括(x,l),其中l是1d朝着网关路由器1c开始最低费用路径的接口，为了决定了，1d在NEXT-HOP属性中提供了到它的AS内部路由选择模块的IP地址，因此，NEXT-HOPS是沿着这条最好路径的该路由器AS之外的第一台路由器地址。



表项是怎么进入路由器的转发表的

&emsp;&emsp;路由器转发表中的一个表项是由一个前缀和一个对应的输出端口组成。当一个分组到达路由器时，使用最长路径匹配原则 ，找到对应的表项。将分组转发到对应的输出端口，。现在总结一下一个路由选择表项(前缀和相关端口)是如何进入到转发表中的。

&emsp;&emsp;为了使一个前缀进入转发表，路由器必须首先知道该前缀(对应一个子网或子网集合)。如我们学习的那样，经过BGP路由通告，该路由器知道了该前缀，那么怎么确定该前缀对应的输出端口呢？

&emsp;&emsp;首先路由器可能会接收到对该前缀的多个路由通报，路由器使用BGP路由选择进程，选出最好的一条路由。前面说过，路由中含有NEXT-HOP属性，它是沿着这条最好路径的该路由器AS之外的第一台路由器的ip地址。于是，使用AS内部选择协议(RIP,OSPF)来确定到NEXT-HOP路由器的最短路径，并使用该路径第一段链路的端口号与前缀绑定。最后，转发表会推入到路由器的输入端口线路卡。