---
typora-copy-images-to: ..\..\img
---

# 链路层：链路、接入网和局域网

## 1简介

我们将讨论两种不同的链路层信道：

1. 广播信道，这种信道用于连接有线局域网、卫星网和混合光纤同轴电缆接入网中的多台主机
2. 点对点通信链路。

### 1.1 链路层概念

&emsp;&emsp;我们将运行链路层协议的任何设备称为结点。结点包括主机、路由器、交换机和WiFi接入点。我们也把沿着通信路径连接相邻节点的通信路径称链路。在通告特殊的链路时，传输节点将数据报封装在链路层帧中，并将该帧传送到链路中。

### 1.2 链路层提供的服务

虽然任何链路层的基本服务都是将数据通过单一通信链路从一个结点移动到另一个相邻结点，但是所提供的服务细节能够随着链路层协议的不同而变化。链路层可能提供的服务包括

- 成帧。一个帧由首部和数据字段组成，网络层的数据报就是其数据字段的一种。帧的结构由链路层协议规定。
- 链路接入。媒体访问协议(MAC)规定了帧在链路上的传输规则。点对点时不存在MAC协议，当多个结点共享广播链路时，即多路访问问题时，链路层用于协调多个结点的帧传输
- 可靠交付
- 差错检测和纠正

### 1.3 链路层在何处实现

链路层的主体部分是在网络适配器中实现，也称网络接口卡(网卡,NIC)。位于网络适配器核心的是链路层控制器，该控制器通常是一个实现了许多链路层服务(成帧、链路接入、差错检测和纠正等)的专用芯片

![1564488274654](..\..\img\1564488274654.png)

&emsp;&emsp;图5.2显示了与主机总线链接的网络适配器。在发送端，控制器取得了由协议栈较高层生成并存储在主机内存中的数据报，在链路层帧中封装该数据报，比如填写给首部字段。然后遵从链路层协议将帧传输到链路。在接收端，控制器接受了整个帧，抽取出网络数据报。如果链路层执行差错检测，则需要发送控制器在帧的首部设置差错检测比特，由接收控制器执行差错检测。尽管大部分工作都是在硬件中完成，但部分链路层是在运行于主机CPU上的软件中实现的。因此，链路层是软硬件的结合体，即此处是协议栈中软件与硬件交接的地方(**链路层以上都是软件**)

## 2 差错检测与纠正技术

### 2.1 奇偶校验

增加一个字节位

奇校验：有奇数个1为正确

偶校验：有偶数个1为正确

### 2.3 二维奇偶校验

![1564488841325](..\..\img\1564488841325.png)

### 2.3 检验和方法

求和取反，接收方重新接受验证数据的检验和与检验字段的值相加，全为1则正确

### 2.4 循环冗余方法

加入r个比特使得d+r能被特定值G整除

![1564488892685](..\..\img\1564488892685.png)

![1564488915165](..\..\img\1564488915165.png)

## 3 多路访问链路和协议

简介中就提到两种类型的网络链路：点对点和广播链路。

广播链路能让多个发送和接受结点都连接到相同的、单一的、共享的广播信道。广播的意思是当任何一个结点传输一个帧，信道广播该帧，每个其他结点都收到了一个副本。以太网和网络局域网是广播链路层技术的例子。在这里面，如何协调多个发送和接受结点对一个共享广播信道的访问，这就是多路访问问题，广播信道常常用于局域网中。

可以将任何多路访问协议划分为3种类型之一

1. 信道划分协议
2. 随机接入协议
3. 轮流协议

### 3.1 信道划分协议

1. 时分多路复用(TDM)
2. 频分多路复用(FDM)

### 3.2 随机接入协议

1. 载波侦听多路访问(CSMA)

   原则：嗅探结点是否是空闲，空闲时才传输数据，如图5.12，,t0时刻，B侦听到信道时空闲的，于是开始发送数据,t1时刻，D也侦听到信道时空闲的，因为B的数据还没床送到D的侦听区域来，于是D也开始发送数据。再经过一个短暂的时间之后，B和D发送数据碰撞，导致所有数据全部损坏，且知道数据传输完。

   ![1564489493256](..\..\img\1564489493256.png)

2. 具有检测碰撞的CSMA(CSMA/CD)

检测到发送碰撞后立即停止传输，并使用二指数后退原则等待一段时候后再重传。

二进制后台，当发生了n个数据碰撞后，结点随机地从{0,1,2,...,2^n -1}种随机选择一个K值，等待k*发送512比特的时间后重传，因此，碰撞次数越多，等待的时间也会随着取值范围变大而变大。

![1564489767944](..\..\img\1564489767944.png)

### 3.3 轮流协议

1. 轮询机制：认定一个结点为主节点，主节点以循环的方式轮询每个结点。比如，主结点先个结点1发送报文，告诉发送帧的最多数量。结点1发送后，主节点又通知结点2能够发送帧的最大数量
2. 令牌传递协议。一种称为令牌的小的特殊帧在结点之间以某种固定的次序进行交换。比如结点1永远发送个结点2，结点2永远发送个结点3.每一个结点接受到令牌后，如果有数据发送，它发送最大数量的帧，然后把令牌发送个下一结点。

## 4 交换局域网

![1564490422519](..\..\img\1564490422519.png)

如图4-15所示，一个交换局域网连接了3个部门，两台服务器和一个与4台交换机相连的路由器。因为交换机运行在链路层，因此它们交换链路层帧，不识别网络地址。

### 4.1 链路层寻址和ARP

#### 4.1.1 MAC地址

之前说过，不是主机或者路由器有链路层地址，而是网络适配器(网络接口)有链路层地址。因此，具有多个网络接口的主机或路由器有多个与之关联的链路层地址，就像它也具有与之关联的多个IP地址一样。然而，重要的是链路层交换机并不具有它们的接口相关联的链路层地址。这是因为链路层交换机的任务是在主机和路由器之间承载数据报；交换机透明地执行该项任务，这就是说，主机或路由器不必明确地将帧寻址到其他交换机。链路层地址有许多称为：LAN地址，物理地址，MAC地址，长度为6字节，使用16进制表示。每个网络适配器对应地MAC地址往往是在生产时就固定了，是唯一地。

IP地址是有层次结构地(前缀+后缀),而Mac地址是扁平地。IP地址类似于人的邮编地址，随着人住所的改变而改变。而MAC地址相当于人的身份证号码，一身只能有一个，且不改变。

#### 4.1.2 地址解析协议

(Address Resolution Protocol) ARP

客户端向服务端请求数据，需要知道服务端的MAC地址。

1. 如图5.17假设客户端C和服务端B在一个子网上，客户端首先发送一个ARP查询分组，该分组包括发送和接受IP和MAC地址字段，且ARP查询与响应分组有相同的格式。查询分组使用目的地的IP地址 222.222.222.223和广播MAC地址FFFFFFFFFFFF。该分组在子网中广播，被所有的适配器接收到，并把该帧的ARP分组上传给ARP模块，IP地址与查询ARP分组目的IP字段匹配的主机发送回一个带有所希望映射的响应ARP分组。因此每个主机和路由器都有一个ARP表，维持IP和MAC地址的映射，一个表项使用TTL表示它的有效时间，一般的有效时间为20分钟，如图5.18所示。

   ![1564491770366](..\..\img\1564491770366.png)

   ![1564532187749](..\..\img\1564532187749.png)

2. 如果在服务端(222.222.222.221)不在客户端(111.111.111.111)的子网之外怎么办。如图5.19。因为子网的 所有适配器都不会将ARP数据发送到网络层，因为IP与之不匹配。因此，这种情况，MAP地址要填的是默认网关路由器的MAC地址（E6-E9-00-17-88-4B）。那客户端怎么获得默认网关路由器的MAC地址呢，当然是使用ARP协议了，当数据到达了路由器后，路由器根据数据报的ip地址查询转发表，找到对应的输出端口，然后将数据报发送到输出端口的适配器上，适配器将服务器的MAC(88-B2-2F-54-1A-0F)地址重写到目的MAC字段。那又是怎么知道这个目的地MAC地址呢，还是使用ARP协议。

![1564491783878](..\..\img\1564491783878.png)

&emsp;&emsp;可能你会疑问ARP协议到底是网络层协议还是链路层协议。它封装在链路层帧中，按道理它是在链路层之上的。可ARP分组既有IP字段又有MAC字段，因此，最好是把ARP看出跨越两种层次边界的协议，现实世界的协议就是这么复杂。

### 4.2 以太网

以太网几乎占领着现有的有线局域网市场。以太网发展有三个阶段

- 初期阶段使用同轴电缆总线来互联结点，是一种广播局域网，即传输的帧传送到与该总线连接的所有适配器上。媒体访问协议使用的是CSMA/CD多路访问协议。
- 中期使用一种基于集线器的星形拓扑以太网取代了之前的局域网。在这种结构中，主机、路由器直接用双绞对铜线与一台集线器相连。集线器是一种物理层设备，它作用于比特而不作用于帧。当表示一个0或1的比特到达一个输入接口时，集线器只是重新生成这个比特，将其能量强度放大，并向其他所有接口传输出去。因此，也是一个广播局域网。特别是如果集线器同时从两个不同的接口接受到了帧，则会发生一次碰撞，生成该帧的结点必须重新传输该帧。
- 如今，集线器被交换机代替，交换机是一种存储转发的设备，仅仅运行在第二层。

#### 4.2.1 以太网帧

帧结构：![1564533796331](..\..\img\1564533796331.png)

| 字段           | 描述                                                         |
| -------------- | ------------------------------------------------------------ |
| Preable        | 前同步码，8字节，前7字节都是10101010，用于唤醒适配器，并且将它们的时钟和发送方的时钟同步，最后一个字节是10101011. |
| Dest address   | 目的地址 MAC                                                 |
| Source address | 源地址 MAC                                                   |
| Data           | 数据 比如ip数据报                                            |
| type           | 类型 应传递数据给上层的那个网络层协议，和网络层首部的协议与运输层首部的端口相似，它是连接链路层和网络层的类型编码 |
| CRC            | 冗余码，循环冗余检测                                         |

以太网技术提供的服务：

1. 所有的以太网技术都向网络层提供无连接服务
2. 以太网技术向网络层提供不可靠服务。当适配器执行CRC校验，但是该帧通过校验与否都不会发送却确认帧。如果没有通过校验，适配器只是丢弃该帧。

### 4.3 链路层交换机

交换机自身对子网的主机和路由器来说是透明的。

#### 4.3.1 交换机转发和过滤

过滤是决定一个帧应该被转发到某个接口还是应当将其丢弃的交换机功能

转发是决定将一个帧导向到哪个接口。交换机的过滤和转发借助于交换机表，如图所示：

![1564534926995](..\..\img\1564534926995.png)

假设MAC地址为DD-DD-DD-DD-DD-DD的帧从交换机的x入口到达。有三种情况

1. 交换机表没有该MAC地址对应的表项，交换机会向除接口x之外的所有接口前面的输出缓存转发该帧的副本，也就是说，如果没有对应的表项，交换机广播该帧。
2. 如果表中有一个表项与该MAC地址与接口x对应起来，则无需转发，过滤该帧即可
3. 如果表中有一个表项与该MAC地址与其他接口对应起来。交换机只将该帧放到该接口前面的输出缓存完成转发功能。

#### 4.3.2 自学习

自学习的交换机减少了网络管理员的很多工作。机制如下：

1. 交换机表初始为空
2. 对于在每个接口接受到的帧，该交换机在其表中存储一个表项：
   - 帧的源MAC地址
   - 到达接口号
   - 时间
3. 如果再过一段时间，交换机没有接收到以该地址为源地址的帧，就会删除这个地址对应的表项

因此，它是即插即用的设备

#### 4.3.3 链路层交换机的性质

交换机的特色和性质

- 消除碰撞：交换机缓存帧并且决不会在网段上同时传输多于一个帧，因此没有因碰撞和浪费的带宽
- 异质的链路。交换机将链路彼此隔离。因此局域网中的链路能够以不同的速率运行并且能够在不同的媒体上运行。
- 方便管理。

#### 4.3.4 交换机和路由器比较

路由器使用网络层地址进行存储转发的第三层分组交换机，交换机是使用MAC地址转发分组，是第二层的分组交换机。

**交换机**：交换机是即插即用的，具有相对高的分组过滤和转发速率。为了防止广播帧的循环，交换机网络的活跃拓扑限制为一颗生成树。但交换机对广播风暴并不提供任何保护措施，即如果某主机出了故障并传输出没完没了的以太网广播帧流，该交换机将转发所有这些帧，导致以太网的崩溃。

**路由器**，因为网络寻址是分层次的，所以即使网络存在冗余数据，分组通常也不会通过路由器循环。所以，分组不会限制在一颗生成树上，并可以使用源和目的地之间的最佳路径。路由器的第二个特色是对第二层的广播风暴提供了防火墙保护。路由器最重要的确定是它不是即插即用的，路由器需要人为的分配IP地址。而且路由器对每个分组的执行时间比交换机更长，需要处理第三层的字段。

综上，如果几百台主机组成的小网络通常有几个局域网网段，对于这些小网络，交换机就够了，但是在由几千台主机组成的更大网络，则需要使用路由器。路由器提供了更健壮的流量隔离方式和对广播风暴的控制，并在主机之间提供更好的路由。



## 5 虚拟局域网

看Vlan详解