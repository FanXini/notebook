---
typora-copy-images-to: ..\..\img
---

![1564537843050](..\..\img\1564537843050.png)

如图5.32，一个学生Bob使用他的笔记本与学校的以太网相连，下载一个页面www.google.com

## 准备：DHCP、UDP、IP和以太网

1. Bob先和以太网相连，此时还没有IP地址，于是采取DHCP协议从DHCP服务器获取一个IP地址
2. 发送DHCP请求报文，将目的端口为79和源端口为68的报文段放入UDP数据报，目的IP地址为广播地址255.255.255.255,源IP地址为0.0.0.0
3. 包含DHCP请求报文的IP数据报则被放置在以太网帧中，该以太网帧的目的地址为广播MAC地址FF-FF-FF-FF-FF-FF，源地址为Bob笔记本的MAC地址。
4. DHCP服务器接收到该帧，抽取出IP数据报给网络层，网络层抽取出请求报文段上传给应用层，此时DHCP服务器有了请求报文。
5. 假设DHCP服务器分配IP地址68.85.2.101给Bob，则DHCP服务器生成一个包含这个IP地址，默认网关路由器地址，本地DNS服务器地址的ACK报文，发送给Bob。
6. 因为交换机是自学习的，所以交换机转发表知道发送给Bob笔记本的接口。
7. Bob接收到信息后，抽取出报文段，记录了自己IP地址和DNS服务器地址，还在IP转发表中记录了默认网关路由器的地址。

## 仍然在准备：DNS和ARP

知道服务器的域名，可还不知道它的ip地址，因此需要访问DNS服务器查询IP地址

1. 笔记本的操作系统生成一个DNS查询报文，放入具有53目的端口号的UDP报文段，并放入到目的地址为68.87.71.226的IP数据报。
2. 数据报到达网络适配器在，准备成帧。当不知道DNS服务器的Mac地址。于是使用ARP协议。因为DNS服务器不和笔记本在一个子网，因此，生成一个ARP查询报文，查询默认网关路由器的MAC地址。目的MAC地址是FF-FF-FF-FF-FF-FF，目的IP地址是68.85.2.1。
3. 网关路由器发送ARP响应报文，则笔记本的适配器将DNS查询帧的目的地址设为默认网关路由器的MAC地址，数据到达路由器后，路由器将DNS服务器的MAC地址放入新的帧。
4. 最终，Bob会得到域名对应的IP地址

## Web客户-服务器交换：TCP和HTTP

有了域名的IP地址后，可以创建TCP套接字，该套接字用于向www.google.com发送HTTP GET报文。生成套接字时，笔记本中的TCP与服务器的TCP执行3次握手协议。

1. 创建目的端口为80的SYN报文段，放到目的地址为服务器Ip地址的数据报，在放入MAC地址为网关路由器Mac地址的帧，
2. 经过RIP，OSPF和BGP运行过后的路由后到达了服务器，服务器回应SYN报文段。
3. 笔记本创建HTTP  GET报文，服务器读取到get报文后，将对应的网页内容放入HTTP响应体中
4. 笔记本接收到响应报文后读取出web页面内容，显示在浏览器
5. 最后，4次挥手解除TCP连接

![1564539362743](..\..\img\1564539362743.png)

![1564539655949](..\..\img\1564539655949.png)